<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <style>
        #container {
            /* width: 500px;
            height: 500px; */
            background-color: #808080;

            position: fixed;
            transform-origin: 0 0;

            background-image: url('https://images.chesscomfiles.com/uploads/v1/images_users/tiny_mce/CHESScom/phphK5JVu.png');
            background-size: 100%;
            background-position: 0 0;
            background-repeat: no-repeat;

            transition: background-position 1s linear, background-size 1s linear;
        }
    </style>
</head>
<body>
    <div id="container"></div>

    <script>
        const container = document.getElementById('container');
        const SIZE = 50;
        const WIDTH = SIZE;
        const HEIGHT = SIZE;
        const IMAGE_URL = 'https://images.chesscomfiles.com/uploads/v1/images_users/tiny_mce/CHESScom/phphK5JVu.png';

        let imageZoom = 1;
        let imagePositionX = 0;
        let imagePositionY = 0;
        const ZOOM_MULTIPLIER = 2;

        container.style.width = WIDTH + 'px';
        container.style.height = HEIGHT + 'px';

        function round(base, dec) {
            const multiplier = Math.pow(10, dec);
            return Math.round(base * multiplier) / multiplier;
        }

        window.onresize = _ => {
            const zoomX = window.innerWidth / WIDTH;
            const zoomY = window.innerHeight / HEIGHT;

            const zoom = Math.max(zoomX, zoomY);

            const x = (window.innerWidth - WIDTH * zoom) / 2;
            const y = (window.innerHeight - HEIGHT * zoom) / 2;

            container.style.left = round(x, 2) + 'px';
            container.style.top = round(y, 2) + 'px';
            container.style.transform = `scale(${zoom})`;
            container.style.bac
        }

        window.onresize();

        container.onclick = e => {
            const clickX = e.offsetX;
            const clickY = e.offsetY;

            // Convert click position to image coordinates (before zoom)
            const clickImageX = (clickX - imagePositionX) / imageZoom;
            const clickImageY = (clickY - imagePositionY) / imageZoom;

            // Apply zoom
            imageZoom *= ZOOM_MULTIPLIER;

            // New position should keep the image point under cursor stationary
            imagePositionX = clickX - clickImageX * imageZoom;
            imagePositionY = clickY - clickImageY * imageZoom;

            container.style.backgroundSize = round(100 * imageZoom, 3) + '%';
            container.style.backgroundPositionX = round(imagePositionX, 3) + 'px';
            container.style.backgroundPositionY = round(imagePositionY, 3) + 'px';
        };


        function loadImage(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "Anonymous"; // To avoid CORS issues
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = url;
            });
        }

        function avgColor(r, g, b) {
            return (r + g + b) / 3;
        }

        function drawTextOnPixel(ctx, color, x, y, scale) {
            const avg = avgColor(color[0], color[1], color[2]);
            const textColor = avg > 128 ? 'black' : 'white';

            const fontSize = HEIGHT / 3 * scale;
            const lineWidth = WIDTH / 6 * scale;

            ctx.fillStyle = `rgb(${color[0]}, ${color[1]}, ${color[2]})`;
            ctx.fillRect(x, y, WIDTH * scale, HEIGHT * scale);

            ctx.fillStyle = textColor;
            ctx.font = `${fontSize}px sans-serif`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.lineWidth = lineWidth;
            ctx.fillText('a', x + WIDTH * scale / 2, y + HEIGHT * scale / 2);
        }

        async function processImage() {
            const img = await loadImage(IMAGE_URL);

            // Original canvas
            const originalCanvas = document.createElement('canvas');
            originalCanvas.width = WIDTH;
            originalCanvas.height = HEIGHT;
            const oCtx = originalCanvas.getContext('2d');
            oCtx.drawImage(img, 0, 0, WIDTH, HEIGHT);

            const imageData = oCtx.getImageData(0, 0, WIDTH, HEIGHT).data;

            // Large canvas
            const finalCanvas = document.createElement('canvas');
            finalCanvas.width = WIDTH * WIDTH;
            finalCanvas.height = HEIGHT * HEIGHT;
            const fCtx = finalCanvas.getContext('2d');

            for (let y = 0; y < HEIGHT; y++) {
                for (let x = 0; x < WIDTH; x++) {
                    const index = (y * WIDTH + x) * 4;
                    const r = imageData[index];
                    const g = imageData[index + 1];
                    const b = imageData[index + 2];
                    drawTextOnPixel(fCtx, [r, g, b], x * WIDTH, y * HEIGHT, 1);
                }
            }

            
            // Set as background image
            const dataURL = finalCanvas.toDataURL('image/png');
            document.getElementById('container').style.backgroundImage = `url(${dataURL})`;
            
            console.log(dataURL);
            console.log('done');
        }

        processImage();

    </script>
</body>
</html>
